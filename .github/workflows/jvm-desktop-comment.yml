name: Comment Desktop CI Artifacts

on:
  pull_request_target:
    types: [ opened, synchronize, reopened ]
    branches: [ 2025/compose-multiplatform ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch build run & artifacts and post comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const sha = pr.head.sha;
            
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: sha,
              event: "pull_request",
            });
            const buildRun = runs.workflow_runs.find(r => r.name === "Compose Desktop(JVM) CI" && r.status === "completed");

            const { data: art } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: buildRun.id,
            });

            const url = name => {
              const a = art.artifacts.find(x => x.name === name);
              return a ? a.archive_download_url : null;
            };
            const win = url("desktop-msi");
            const mac = url("desktop-dmg");
            const lin = url("desktop-deb");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `
              ğŸš€ **ë¹Œë“œ ê²°ê³¼ ìš”ì•½**
              - ğŸªŸ Windows: ${win ? `[ë‹¤ìš´ë¡œë“œ](${win})` : "âŒ ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤"}
              - ğŸ macOS:   ${mac ? `[ë‹¤ìš´ë¡œë“œ](${mac})` : "âŒ ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤"}
              - ğŸ§ Linux:  ${lin ? `[ë‹¤ìš´ë¡œë“œ](${lin})` : "âŒ ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤"}
              `.trim()
            });
